{
    "SaveName": "",
    "Date": "",
    "VersionNumber": "",
    "GameMode": "",
    "GameType": "",
    "GameComplexity": "",
    "Tags": [],
    "Gravity": 0.5,
    "PlayArea": 0.5,
    "Table": "",
    "Sky": "",
    "Note": "",
    "TabStates": {},
    "LuaScript": "",
    "LuaScriptState": "",
    "XmlUI": "",
    "ObjectStates": [
        {
            "GUID": "681a9f",
            "Name": "BlockSquare",
            "Transform": {
                "posX": 0.0,
                "posY": 0.0,
                "posZ": 0.0,
                "rotX": 0.0,
                "rotY": 0.0,
                "rotZ": 0.0,
                "scaleX": 1.0,
                "scaleY": 1.0,
                "scaleZ": 1.0
            },
            "Nickname": "Token Creator",
            "Description": "",
            "GMNotes": "",
            "AltLookAngle": {
                "x": 0.0,
                "y": 0.0,
                "z": 0.0
            },
            "ColorDiffuse": {
                "r": 0.113725014,
                "g": 0.250979662,
                "b": 1.0
            },
            "Tags": [
                "lsUpgrader"
            ],
            "LayoutGroupSortIndex": 0,
            "Value": 0,
            "Locked": false,
            "Grid": true,
            "Snap": true,
            "IgnoreFoW": false,
            "MeasureMovement": false,
            "DragSelectable": true,
            "Autoraise": true,
            "Sticky": true,
            "Tooltip": true,
            "GridProjection": false,
            "HideWhenFaceDown": false,
            "Hands": false,
            "LuaScript": "---@diagnostic disable: duplicate-doc-alias, duplicate-doc-field, duplicate-set-field\n\n---@alias WeaponType 'ranged'|'melee'\n\n---@class (exact) WeaponData\n---@field image string\n---@field psychic? boolean\n---@field legendary? boolean\n\n---@type { [WeaponType]: { [string]: WeaponData } }\nlocal weapons = {\n    ranged = {\n        [\"Boltgun\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045822605410/441D4A3AF7ECC5E5207EE5DD4AEF7AE14CDACBAA/' },\n\n        --[ AELDARI ]--\n        [\"D-cannon\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045837497853/71075587E7EED7EC649B55BC94D9FDD159386CDD/' },\n        [\"Destructor\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045837275902/836DD060AF16CEE76A8A59F491C41D9907977821/',\n            psychic = true\n        },\n        [\"Eldritch Storm\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045837275957/1B3376A024C9A51CD77403DDFECEB7335A99EADC/',\n            psychic = true,\n        },\n        [\"Fury of the Tempest\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045837466631/89E7FBD27D14E5BC059988AA752011D7C2DF7DC3/' },\n        [\"Las-blaster\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045837466700/7B2C15A485725C5FD853B819D7FB380FC29DFA2E/' },\n        [\"Prism cannon\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045837491216/62F2E2F4A1138900135FA897B80FB7CBA4BDC770/' },\n        [\"Prism rifle\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045837491216/62F2E2F4A1138900135FA897B80FB7CBA4BDC770/' },\n        [\"Ranger long rifle\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045837276007/828BB1F31088BD2DE43A6AAB6FFB5D03B6EF7541/' },\n        [\"Reaper launcher\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045842351026/BEA6AC012592176F6F0388A9D78AC1369244B93E/' },\n        [\"Searsong\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045843022977/9B5349F7AA8A0E2E935EFB4ECA859B1D160DA70F/' },\n        [\"Shuriken cannon\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045837276078/00BCA7379E46DD5741F65DB8FB3A7A7A4DCFBE30/' },\n        [\"Shuriken catapult\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045837276145/56F051876AF13221DB1B8B4E0B1984E51AE9F8E3/' },\n        [\"Shuriken pistol\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045837276209/C1D3F6B7C845C8CD20426A9224A74B072C3E7EB6/' },\n        [\"Singing spear\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045837276314/60CCFBCA87D883CD290D4520FD9FCA8E654C0CB8/' },\n        [\"Storm of Whispers\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045842350877/CB79D094301179E8A87A19E03D2E9A879663E36C/',\n            psychic = true,\n            legendary = true\n        },\n        [\"Swirling soul energy\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045842351075/B896E353733F6621600893782F56A7CFD445DA6F/',\n            psychic = true\n        },\n        [\"Twin shuriken cannon\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045843023179/87EB000DE62F1063B91F1472827D16CB5E5C4F12/' },\n        [\"Twin shuriken catapult\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045837276366/6D0A2F9FDD059F0D7A69BD65CF6A90C349C85A78/' },\n        [\"Voidbringer\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045837276482/857D80904506FBDE567E1746D44EB0EEEB45D979/',\n            legendary = true\n        },\n        [\"Wraithcannon\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045837497853/71075587E7EED7EC649B55BC94D9FDD159386CDD/' },\n\n        --[ IMPERIUM ]--\n        [\"Autocannon\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825226821/ABEADFEC16DAFCD8E0D68559D51AB6D413382FF8/' },\n        [\"Battle cannon\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2290711113495397861/3F79F235859E5409D2F95F0D831DB82B578A87CE/' },\n        [\"Bolt pistol\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825448007/AC013F9316F648BEF193CD32693B46D262672AD1/' },\n        [\"Combi-weapon\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026112042190146381/AE9EED38BC26E9DA8EDC6E7AF4D997E9125DABC3/' },\n        [\"Demolisher battle cannon\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825543678/98876EA4EFE8DD885C1EEE6701036A53EB0CAD08/' },\n        [\"Flamer\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825441876/62710BF8DD36AC949805999B5E0B3827FC3E78CA/' },\n        -- Gatling cannon\n        -- Hand flamer\n        [\"Heavy bolter\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825225475/A0CAA80369CC02298FA61BC20E78101E77B8CDEB/' },\n        [\"Heavy flamer\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045849081260/9CE1A271BCFBA0CC5B7BA5CDC319217E6507A1F1/' },\n        [\"Heavy stubber\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825189261/056A4DCF500E82B4335BFEA26C56ADFF6216796E/' },\n        [\"Hunter-killer missile\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825173330/74F2361949950FFA2FE2D85DB0F5E7E4D00B82C1/' },\n        [\"Lascannon\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026109925065822863/B15EC01F2F196B09E60A09D173277319B95C3534/' },\n        [\"Meltagun\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045849190911/093F446C9944AB95620B64B99D0FFA03F2067A94/' },\n        -- Missile launcher\n        [\"Multi-melta\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825541751/9FE95DCF1AE663156F3059207DB328483728B93A/' },\n        [\"Plasma cannon\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2290711113495572727/BF7CED5203FA28021E34913F4623F5C254A41F77/' },\n        [\"Plasma gun\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825462245/22178A298AE143A272629550256E5BEFBE721B37/' },\n        [\"Plasma pistol\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825286980/FCD007E432C1212863252C34C61D0C7AC0305AAB/' },\n        [\"Storm bolter\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026109925065847883/C22DBAE979A23E492F157D06ABC5D194D5513423/' },\n        [\"Twin-linked heavy bolter\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344076931/C267FEF1AC23384B2BD4BE854283A6225CEAA6D1/' },\n        [\"Twin-linked heavy flamer\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344076995/D3CDDCEDEBB50815B498B07A11E60B0FFB1FB613/'},\n        [\"Twin-linked heavy stubber\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344077046/6F839CFCEEF15BA1FC41D87A3D2C7AE5D5AFC3EB/' },\n        [\"Twin heavy bolter\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344076931/C267FEF1AC23384B2BD4BE854283A6225CEAA6D1/' },\n        -- Twin multi-melta\n        -- Twin storm bolter\n\n        --[ ADEPTA SOROITAS ]--\n        [\"Condemnor boltgun\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045842469370/F28998B43BA740097642A4762A081CF3D901B0FC/' },\n        [\"Fidelis\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344070783/0F17614B9D6276A96A854A24F5DD53FA7566B85A/',\n            legendary = true\n        },\n        [\"Paragon grenade launchers\"] = { image =  'https://steamusercontent-a.akamaihd.net/ugc/2467488810344070908/64EF21B94B700B2344A5B136E5F010952251176E/' },\n        [\"Paragon missile launcher\"] = {image = 'https://steamusercontent-a.akamaihd.net/ugc/2026109925065839329/9B74D5C7E351D7E07CF6D32118DF002DA9B42873/' },\n        -- [\"Twin Ministorum heavy flamer\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344076995/D3CDDCEDEBB50815B498B07A11E60B0FFB1FB613/'},\n\n        --[ ADEPTUS ASTARTES ]--\n        -- Fragstorm grenade launcher\n        -- Icarus rocket pod\n        -- Incendium cannon - heavy flamer\n        -- [\"Lancer laser destroyer\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026109925065822863/B15EC01F2F196B09E60A09D173277319B95C3534/' },\n        -- [\"Las-talon\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026109925065822863/B15EC01F2F196B09E60A09D173277319B95C3534/' },\n        -- Macro plasma incinerator - plasma cannon\n        -- Smite\n        -- Twin icarus ironhail heavy stubber\n        -- Twin ironhail autocannon\n        -- Twin ironhail heavy stubber\n        [\"Typhoon missile launcher\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045832620758/42A369BB53993986AC77F491E6FF8628E28AAE2F/' },\n\n        --[ AGENTS OF THE IMPERIUM ]--\n        [\"Arbites grenade launcher\"] = {image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045837845664/AA480A7D611868E6978B5BDD68957B8600501AF4/'},\n        [\"Archeotech pistol\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045828451561/9CD5D80B8103CCD2E574117BEB8116876BC5C63A/' },\n        [\"Castigation\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045847666883/4F0407B7191CACE5FCC1FEA33D0AB3633ECDBDAC/',\n            psychic = true,\n            legendary = true\n        },\n        [\"Condemnor stake\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045842469370/F28998B43BA740097642A4762A081CF3D901B0FC/' },\n        [\"Exitus pistol\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825448007/AC013F9316F648BEF193CD32693B46D262672AD1/' },\n        [\"Exitus rifle\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825408110/662E6E109A450BEA5BB99FBD4E29618A327CD8C0/' },\n        -- [\"Mind Assault\"] = {\n        --     image = nil,\n        --     psychic = true,\n        --     legendary = true\n        -- },\n        -- [\"Psychic Blast\"] = {\n        --     image = nil,\n        --     psychic = true\n        -- },\n        [\"Psychic Shock Wave\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2026112042190162250/164F281B6C91D1AF6B3C2CF87BD74BF6EABFCA69/',\n            psychic = true\n        },\n        -- [\"Unholy Gaze\"] = {\n        --     image = nil,\n        --     psychic = true\n        -- },\n\n        --[ ASTRA MILITARUM ]--\n        [\"Deathstrike missile\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344221887/AC8F3D9D22C114D28F82F351CCEB813E1D7A38F6/' },\n        [\"Drum-fed autogun\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825459964/06AD75B5FC773BB139CB67A8A2F0FA25F8DFFAFB/' },\n        [\"Duty and Vengeance\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045832865093/C09880FC0EA1EF2FAC8FC7EAF63A1988F3164770/',\n            legendary = true\n        },\n        [\"Earthshaker cannon\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825433773/8B6FAE1EBA5F31057877218585B1366494E8D789/' },\n        [\"Grenade launcher\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045837845664/AA480A7D611868E6978B5BDD68957B8600501AF4/' },\n        [\"Hellstrike missiles\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045832620758/42A369BB53993986AC77F491E6FF8628E28AAE2F/' },\n        [\"Hot-shot lasgun\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825248834/E7DBCFC37C33C05A3742329F10B3427B5CC94A0B/' },\n        [\"Hot-shot volley gun\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825351383/78734041E0F25B19462A5D672051C0D467C2ECF9/' },\n        [\"Lasgun\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825250389/DF131501F2F8180DB0F0CFF19E62C0EA0EE7D19B/' },\n        [\"Laspistol\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825223251/72EFA93577BD335CFFA95AA41995E6CA6FB93FA7/' },\n        -- [\"Las small arms\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825223251/72EFA93577BD335CFFA95AA41995E6CA6FB93FA7/' },\n        [\"Multi-laser\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825351383/78734041E0F25B19462A5D672051C0D467C2ECF9/' },\n        [\"Multiple rocket pod\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026109925065839329/9B74D5C7E351D7E07CF6D32118DF002DA9B42873/' },\n        [\"Psychic Maelstrom\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825572994/D0711FE404E090D662ACDFA18F1827E21191E8E4/',\n            psychic = true\n        },\n        -- [\"Punisher gatling cannon\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825195985/DCE6C3CE90578BB3D6A6C6226689CF1E09DA67D2/' },\n        [\"Sniper rifle\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825408110/662E6E109A450BEA5BB99FBD4E29618A327CD8C0/' },\n        [\"Sol's Righteous Gaze\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045832693358/E3735293E9200FB802C7ECB12FF9B8AEF97B81B2/',\n            legendary = true\n        },\n        [\"Twin assault cannon\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045847667346/548A9E1B64E17569E3997A1A9FB12BF57DF20345/' },\n        [\"Vanquisher battle cannon\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2290711113495397861/3F79F235859E5409D2F95F0D831DB82B578A87CE/' },\n\n        --[ GREY KNIGHTS ] --\n        -- [\"Gatling psilencer\"] = {\n        --     image = nil,\n        --     psychic = true\n        -- },\n        -- [\"Heavy psycannon\"] = {\n        --     image = nil,\n        --     psychic = true\n        -- },\n        [\"Incinerator\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045849943692/D7EEE3D81AF652C67D53FD7B57CCD6165EB4EA2E/' },\n        [\"Psilencer\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2026112042190162167/CF3EDBBFE9DF65FE6EF86713BACD245FCC45C887/',\n            psychic = true\n        },\n        [\"Psycannon\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045847667093/FE4DB4D04A05D5C94FDD9BFEE773ADE5FCE08598/',\n            psychic = true\n        },\n        [\"Purge Soul\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045847667150/B0412A3841879F1BE89228F6D888BD18618899F0/',\n            psychic = true\n        },\n        [\"Purifying Flame\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045847667283/BA089F2E68B96DB9AC860C7A1A86ADE77914C035/',\n            psychic = true\n        },\n\n        --[ TYRANIDS ]--\n        [\"Barblauncher\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344084546/083DA273F092647FAB8F95E320E9FD05A57874AC/' },\n        [\"Bio-plasma torrent\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344083876/5BE418ACE753915C1971A5661C446BB6BDE1CB63/' },\n        [\"Dire bio-cannon\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344083967/2FED4941C25E81EF480A238C3B6C21602139773A/' },\n        [\"Deathspitter\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344084196/9C2B76ED83AD7B8F470825A6C619E42C18FD21C8/' },\n        [\"Fleshborer\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344084244/3418529A71D93348E006BF0809A4B7AF72E74752/' },\n        [\"Rupture cannon\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344084409/28B78ACF8000FEF9E900F598E5FD92D561DEE196/' },\n        [\"Shardlauncher\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344157180/E83B6AB56F3DC2FC303DB738B99849A9B01BC110/' },\n        [\"Spike rifle\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344084494/E5FDA7C57006FF1746EF66BA9393A101337151CF/' },\n        [\"Stinger salvoes\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344084593/9A46075DBEA979E5B0EA5737A90E8616969B7AD5/' },\n        [\"Stranglethorn cannon\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344084641/598D6EFED71D6584B032DD8ED8B485D9FFECB50F/' },\n        [\"Strangleweb\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344208889/E1653A4DA90E26E327E8AAF4F5F28A1454BFE089/' },\n        [\"Toxinjector harpoon\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344084686/8A4DEB40AB2B0C0EC138FD862E931E219C2AE603/' },\n        [\"Venom cannon\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344084725/8582A548F47565A0356B2C30DCCA1EFA7F5CCE4E/' },\n        [\"Warp Blast\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344084760/A4F4013CF888F2AB680FA25F6CCD89D165900724/',\n            psychic = true\n        }\n    },\n    melee = {\n        [\"Close combat weapon\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045822606558/32E4DAB0ADF4BAF6A9E49BC04DDFA0CC1AEE75E4/'},\n        [\"Force weapon\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045822610141/03CCEF8A833FA27D11DAF132EAE3BF9EB98DAB6E/',\n            psychic = true\n        },\n\n        --[ AELDARI ]--\n        [\"Aeldari power sword\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825388719/E63CD28028075E402AFD8D90955D1CEC53E65B90/' },\n        [\"Kha-vir, the Sword of Sorrows\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045842350784/92D53550008F1576CF8B78719CC3794F0AC101BB/',\n            legendary = true\n        },\n        [\"Singing spear\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045837276260/DEAD6D79EB15944D749482AAB31A12ED6115DA25/' },\n        [\"Star glaive\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045837556657/9822CDD339C7F33B6474EE41C6289AFD4D90450E/' },\n        [\"The Fire Axe\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045843023119/4A612572F82CD9574244FC3DD4BA0F474B2F8268/',\n            legendary = true\n        },\n        [\"The Shining Blade\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045842350956/28DCD6D32B16C7AF6D513389529D5428565E30F1/',\n            legendary = true\n        },\n        [\"Vilith-zhar, the Sword of Souls\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045842350784/92D53550008F1576CF8B78719CC3794F0AC101BB/',\n            legendary = true\n        },\n        [\"Witchblade\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045837276550/CDE64AD7C87AA906F0DADBD026AEBB80CEFDBC3C/' },\n        [\"Witchstaff\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045837276609/2B04E78AF39C6AF43711C8753B253B90EB92B4B4/' },\n        [\"Wraithbone hull\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045843023062/0330E0B641A6C9703223C1D9C24F63DD59854C08/' },\n\n        --[ IMPERIUM ]--\n        [\"Armoured tracks\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825698167/498079035E4730F8BE8AA73D5095601C7EA6D1B6/' },\n        [\"Chainsword\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825185155/E0588C6C98F6610EC656E6E9F4D65FA76FA8FAE0/' },\n        [\"Power fist\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825241546/55D094728E760104B27A09DA217FB05C33BB8210/' },\n        [\"Power weapon\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825388719/E63CD28028075E402AFD8D90955D1CEC53E65B90/' },\n        [\"Servo-arm\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045828439253/E3BD530078A1A56AC29F9FB023ECF27706894947/' },\n\n        --[ ADEPTA SORORITAS ]--\n        [\"Lance of Illumination\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344070861/25B86BC81ED85039475A205C7CBFC18B6E9FD332/',\n            legendary = true\n        },\n        [\"Mace of Castigation\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810353912621/C24C2982191C13DBF8E3351CC4B9CAFB5C12125D/',\n            legendary = true\n        },\n        [\"Paragon war blade\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344070955/FEE40F173E6DA5D5E8EC090A7CDCA8892505C34A/'},\n        [\"Penitent buzz-blade\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344070997/6C8B1A68A5714C9B0A15F0ADCC6537F27E751655/'},\n        [\"Penitent flail\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344446885/41481C0BA4387310EE6564CCFEDB3027457E3601/'},\n\n        --[ ADEPTUS ASTARTES ]--\n        -- Armoured feet (dreadnought)\n        -- Invictor feet\n        -- Relic weapon - power weapon\n        -- Thunder hammer\n\n        --[ AGENTS OF THE IMPERIUM ]--\n        -- ['Runestaff and Barbarisater'] = {\n        --     image = nil,\n        --     psychic = true,\n        --     legendary = true\n        -- },\n        [\"Vindicare combat knife\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825618029/63B1D6D5DB29D55C43A17EBA68D8088638B4D73F/' },\n        -- [\"Warp grasp\"] = {\n        --     image = nil,\n        --     psychic = true\n        -- },\n\n        --[ ASTRA MILITARUM ]--\n        [\"Bullgryn maul\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045832619521/9CAD358A04AB8E4E5F9B047B40C061F4FA41F8CA/' },\n        [\"Conquest\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045832693106/A0217D80AE808EB361C12A43C338E2D53B6CF00E/',\n            legendary = true\n        },\n        [\"Enginseer axe\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045828442487/FEE7CAB830F0BD145FAD086D060D9C33C0014177/' },\n        [\"Excruciator maul\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045832619521/9CAD358A04AB8E4E5F9B047B40C061F4FA41F8CA/' },\n        [\"Konstantin's hooves\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045843040319/D0AEDE3B014303FB34EBD57C74B920435EEC21C1/',\n            legendary = true\n        },\n        [\"Sentinel chainsaw\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825185155/E0588C6C98F6610EC656E6E9F4D65FA76FA8FAE0/' },\n        [\"Tempestus dagger\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045825618029/63B1D6D5DB29D55C43A17EBA68D8088638B4D73F/' },\n\n        --[ GREY KNIGHTS ]--\n        [\"Black Blade of Antwyr\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045832598461/5E8C43485CE58E6963D77735F7EB1AF9DA6D5C6E/',\n            legendary = true\n        },\n        [\"Nemesis daemon hammer\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045849943813/6EFF5FDA1FA989ED559A7ACB70C9A034C74C9426/',\n            psychic = true\n        },\n        [\"Nemesis force weapon\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045822610141/03CCEF8A833FA27D11DAF132EAE3BF9EB98DAB6E/',\n            psychic = true\n        },\n        [\"Nemesis greatsword\"] = {\n            image = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045849943753/00EEC9A9FF7C0EB285E82F929479F00057CD87BE/',\n            psychic = true\n        },\n\n        --[ TYRANIDS ]--\n        [\"Blinding venom\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344084052/1DABC9EF9AE3CE95C7123B0D134E24472DA0BCC5/' },\n        [\"Bone cleaver, lash whip and rending claws\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344084352/04F8ED4AB795567842EF0F76E59642F19011560C/ '},\n        [\"Claws and talons\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344084352/04F8ED4AB795567842EF0F76E59642F19011560C/' },\n        [\"Chitinous claws and teeth\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344084142/9B8459BAC4CFE18578792725A7A07AD17139EE1C/' },\n        [\"Lashwhip pods\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344119574/2B8CA3E299A05377101DFF5917023D04AE08D328/' },\n        [\"Lictor claws and talons\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344084456/19BBBF7EDD76BA7FF816C4FBD235F0C7406F51CF/' },\n        [\"Monstrous bonesword and lash whip\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344084091/36B0517E46DB18DB388337FAE77B8FB65BEB022C/' },\n        [\"Powerful limbs\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344084142/9B8459BAC4CFE18578792725A7A07AD17139EE1C/' },\n        [\"Talons\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344084456/19BBBF7EDD76BA7FF816C4FBD235F0C7406F51CF/' }, -- (Hormagaunt|Scything) talons\n        [\"Toxinjector harpoon\"] = { image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810344084686/8A4DEB40AB2B0C0EC138FD862E931E219C2AE603/' },\n    }\n}\n-- Weapons with the same images\nweapons.ranged[\"Bolt rifle\"] = weapons.ranged[\"Boltgun\"]\nweapons.ranged[\"Incendium cannon\"] = weapons.ranged[\"Heavy flamer\"]\nweapons.ranged[\"Lancer laser destroyer\"] = weapons.ranged[\"Lascannon\"]\nweapons.ranged[\"Las-talon\"] = weapons.ranged[\"Lascannon\"]\nweapons.ranged[\"Las small arms\"] = weapons.ranged[\"Las pistol\"]\nweapons.ranged[\"Plasma incinerator\"] = weapons.ranged[\"Plasma cannon\"]\nweapons.melee[\"Relic weapon\"] = weapons.ranged[\"Power weapon\"]\n\n---@type { [WeaponType]: { [boolean]: string } }\nlocal default_images = {\n    ranged = {\n        [false] = weapons.ranged[\"Boltgun\"].image,\n        [true] --[[psychic]] = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045822609013/EEE503BFF12F6115F74250E20E9F273CD539E0B0/',\n    },\n    melee = {\n        [false] = weapons.melee[\"Close combat weapon\"].image,\n        [true] --[[psychic]] = weapons.melee[\"Force weapon\"].image\n    }\n}\n---@enum (key) StrategemCategory\nlocal strategem_category = {\n    GENERAL = 1,\n    OFFENSIVE = 2,\n    DEFENSIVE = 3,\n}\nlocal back_images = {\n    [false] = {\n        [false] = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045832884821/0A9B55C26FFDD27A7C9E2248BE9D4F91E561062B/',\n        [true] --[[psychic]] = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045822608060/33AC0A15C0BC928064EC3BBBA73B12E62BADAB41/'\n    },\n    [true] --[[legendary]] = {\n        [false] = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045832651659/76A05F01F0EB89E03637F0CF8269DE13751DE004/',\n        [true] --[[psychic]] = 'https://steamusercontent-a.akamaihd.net/ugc/2026110045832693287/EBB6D1AE07975A2D04E26523D342131E29C74024/'\n    },\n    strategems = {\n        general = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810349541832/266015246B204C0E12B0EFF5F2EB8CC774BFEF3E/',\n        offensive = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810349542029/377E8172DE7259FD25D2DFD01443CA76D64FA404/',\n        defensive = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810349541778/7411C0C66A01B3D72431BB3AF3ECA1FAD6797B92/'\n    }\n}\n\n---@enum strategem_colors\nlocal STRATEGEM_COLORS = {\n    general = '82dccf',\n    offensive = '69c9f6',\n    defensive = 'f34a4e'\n}\n\n---@class (exact) StrategemData\n---@field category StrategemCategory\n---@field name string\n---@field cost integer\n---@field desc string\n---@field image string\n---@field back string\n---@field faction? string\n---@field keywords? string[]\n---@field restriction? string\n---@field exception? string\n---@field ability? string\n\n---@type { [string]: StrategemData }\nlocal strategems = {\n    --[ CORE ]--\n--     [\"Command Re-roll\"] = {\n--         category = 'GENERAL',\n--         name = ('[%s]COMMAND RE-ROLL[-]'):format(STRATEGEM_COLORS.general),\n--         cost = 1,\n--         desc = ([=[[b]Core – Battle Tactic Stratagem[/b]\n-- [i]A great commander can bend even the vagaries of fate and fortune to their will, the better to ensure victory.[/i]\n-- [%s][b]WHEN:[/b][-] Any phase, just after you make an Advance roll, a Charge roll, a Desperate Escape test or a Hazardous test for a unit from your army, or a Hit roll, a Wound roll, a Damage roll or a saving throw for a model in that unit, or a roll to determine the number of attacks made with a weapon equipped by a model in that unit.\n\n-- [%s][b]TARGET:[/b][-] That unit from your army.\n\n-- [%s][b]EFFECT:[/b][-] You re-roll that roll, test or saving throw.]=]\n--         ):format(STRATEGEM_COLORS.general, STRATEGEM_COLORS.general, STRATEGEM_COLORS.general),\n--         image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810349666911/86F06EC5AA67EEE4523312E55A335818B4D6F141/',\n--         back = back_images.strategems.general,\n--     },\n    [\"Counter-offensive\"] = {\n        category = 'GENERAL',\n        name = ('[%s]COUNTER-OFFENSIVE - 2CP[-]'):format(STRATEGEM_COLORS.general),\n        cost = 2,\n        desc = ([=[[b]Core – Strategic Ploy Stratagem[/b]\n[i]In close-quarters combat, the slightest hesitation can leave an opening for a swift foe to exploit.[/i]\n[%s][b]WHEN:[/b][-] Fight phase, just after an enemy unit has fought.\n\n[%s][b]TARGET:[/b][-] One unit from your army that is within Engagement Range of one or more enemy units and that has not already been selected to fight this phase.\n\n[%s][b]EFFECT:[/b][-] Your unit fights next.]=]\n        ):format(STRATEGEM_COLORS.general, STRATEGEM_COLORS.general, STRATEGEM_COLORS.general),\n        image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810349667262/C680A542A0579555C56C23394F94E6BCBF644231/',\n        back = back_images.strategems.general\n    },\n    [\"Epic Challenge\"] = {\n        category = 'GENERAL',\n        name = ('[%s]EPIC CHALLENGE - 1CP[-]'):format(STRATEGEM_COLORS.general),\n        cost = 1,\n        desc = ([=[[b]Core – Epic Deed Stratagem[/b]\n[i]The legends of the 41st Millennium are replete with deadly duels between mighty champions.[/i]\n[%s][b]WHEN:[/b][-] Fight phase, when a CHARACTER unit from your army that is within Engagement Range of one or more Attached units is selected to fight.\n\n[%s][b]TARGET:[/b][-] One CHARACTER model in your unit.\n\n[%s][b]EFFECT:[/b][-] Until the end of the phase, all melee attacks made by that model have the [PRECISION] ability.]=]\n        ):format(STRATEGEM_COLORS.general, STRATEGEM_COLORS.general, STRATEGEM_COLORS.general),\n        image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810349666911/86F06EC5AA67EEE4523312E55A335818B4D6F141/',\n        back = back_images.strategems.general,\n        keywords = {'Character'}\n    },\n    [\"Grenade\"] = {\n        category = 'OFFENSIVE',\n        name = ('[%s]GRENADE - 1CP[-]'):format(STRATEGEM_COLORS.offensive),\n        cost = 1,\n        desc = ([=[[b]Core – Wargear Stratagem[/b]\n[i]Priming their hand-held projectiles, these warriors draw back and hurl death into the enemy’s midst.[/i]\n[%s][b]WHEN:[/b][-] Your Shooting phase.\n\n[%s][b]TARGET:[/b][-] One GRENADES unit from your army that is not within Engagement Range of any enemy units and has not been selected to shoot this phase.\n\n[%s][b]EFFECT:[/b][-] Select one enemy unit that is not within Engagement Range of any units from your army and is within 8\" of and visible to your GRENADES unit. Roll six D6: for each 4+, that enemy unit suffers 1 mortal wound.]=]\n        ):format(STRATEGEM_COLORS.offensive, STRATEGEM_COLORS.offensive, STRATEGEM_COLORS.offensive),\n        image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810349541971/34BC3DDB2D4E813C41C1F61DB120D33B501A850D/',\n        back = back_images.strategems.offensive,\n        keywords = {'Grenades'}\n    },\n    [\"Tank Shock\"] = {\n        category = 'OFFENSIVE',\n        name = ('[%s]TANK SHOCK - 1CP[-]'):format(STRATEGEM_COLORS.offensive),\n        cost = 1,\n        desc = ([=[[b]Core – Strategic Ploy Stratagem[/b]\n[i]Ramming the foe with a speeding vehicle may be an unsubtle tactic, but it is a murderously effective one.[/i]\n[%s][b]WHEN:[/b][-] Your Charge phase.\n\n[%s][b]TARGET:[/b][-] One VEHICLE unit from your army.\n\n[%s][b]EFFECT:[/b][-] Until the end of the phase, after your unit ends a Charge move, select one enemy unit within Engagement Range of it, then select one melee weapon your unit is equipped with. Roll a number of D6 equal to that weapon’s Strength characteristic. If that Strength characteristic is greater than that enemy unit’s Toughness characteristic, roll two additional D6. For each 5+, that enemy unit suffers 1 mortal wound (to a maximum of 6 mortal wounds).]=]\n        ):format(STRATEGEM_COLORS.offensive, STRATEGEM_COLORS.offensive, STRATEGEM_COLORS.offensive),\n        image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810349542127/F0A0DC81ED960A9FA28AD40A1E51FBB58C6BF237/',\n        back = back_images.strategems.offensive,\n        keywords = {'Vehicle'}\n    },\n--     [\"Rapid Ingress\"] = {\n--         category = 'DEFENSIVE',\n--         name = ('[%s]RAPID INGRESS - 1CP[-]'):format(STRATEGEM_COLORS.defensive),\n--         cost = 1,\n--         desc = ([=[[b]Core – Strategic Ploy Stratagem[/b]\n-- [i]Be it cunning strategy, potent technology or supernatural ritual, there are many means by which a commander may hasten their warriors’ onset.[/i]\n-- [%s][b]WHEN:[/b][-] End of your opponent’s Movement phase.\n\n-- [%s][b]TARGET:[/b][-] One unit from your army that is in Reserves.\n\n-- [%s][b]EFFECT:[/b][-] Your unit can arrive on the battlefield as if it were the Reinforcements step of your Movement phase, and if every model in that unit has the Deep Strike ability, you can set that unit up as described in the Deep Strike ability (even though it is not your Movement phase).\n\n-- [%s][b]RESTRICTIONS:[/b][-] You cannot use this Stratagem to enable a unit to arrive on the battlefield during a battle round it would not normally be able to do so in.]=]\n--         ):format(STRATEGEM_COLORS.defensive, STRATEGEM_COLORS.defensive, STRATEGEM_COLORS.defensive, STRATEGEM_COLORS.defensive),\n--         image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810350218067/57A04D95D23140B997D6321F61F9A802CBC0FC6D/',\n--         back = back_images.strategems.defensive,\n--     },\n--     [\"Fire Overwatch\"] = {\n--         category = 'DEFENSIVE',\n--         name = ('[%s]FIRE OVERWATCH - 1CP[-]'):format(STRATEGEM_COLORS.defensive),\n--         cost = 1,\n--         desc = ([=[[b]Core – Strategic Ploy Stratagem[/b]\n-- [i]A hail of wildfire can drive back advancing foes.[/i]\n-- [%s][b]WHEN:[/b][-] Your opponent’s Movement or Charge phase, just after an enemy unit is set up or when an enemy unit starts or ends a Normal, Advance, Fall Back or Charge move.\n\n-- [%s][b]TARGET:[/b][-] One unit from your army that is within 24\" of that enemy unit and that would be eligible to shoot if it were your Shooting phase.\n\n-- [%s][b]EFFECT:[/b][-] If that enemy unit is visible to your unit, your unit can shoot that enemy unit as if it were your Shooting phase.\n\n-- [%s][b]RESTRICTIONS:[/b][-] You cannot target a TITANIC unit with this Stratagem. Until the end of the phase, each time a model in your unit makes a ranged attack, an unmodified Hit roll of 6 is required to score a hit, irrespective of the attacking weapon’s Ballistic Skill or any modifiers. You can only use this Stratagem once per turn.]=]\n--         ):format(STRATEGEM_COLORS.defensive, STRATEGEM_COLORS.defensive, STRATEGEM_COLORS.defensive, STRATEGEM_COLORS.defensive),\n--         image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810350218067/57A04D95D23140B997D6321F61F9A802CBC0FC6D/',\n--         back = back_images.strategems.defensive,\n--         restriction = 'Titanic',\n--     },\n    [\"Go to Ground\"] = {\n        category = 'DEFENSIVE',\n        name = ('[%s]GO TO GROUND - 1CP[-]'):format(STRATEGEM_COLORS.defensive),\n        cost = 1,\n        desc = ([=[[b]Core – Battle Tactic Stratagem[/b]\n[i]Seeking salvation from incoming fire, warriors hurl themselves into whatever cover they can find.[/i]\n[%s][b]WHEN:[/b][-] Your opponent’s Shooting phase, just after an enemy unit has selected its targets.\n\n[%s][b]TARGET:[/b][-] One INFANTRY unit from your army that was selected as the target of one or more of the attacking unit’s attacks.\n\n[%s][b]EFFECT:[/b][-] Until the end of the phase, all models in your unit have a 6+ invulnerable save and have the Benefit of Cover.]=]\n        ):format(STRATEGEM_COLORS.defensive, STRATEGEM_COLORS.defensive, STRATEGEM_COLORS.defensive),\n        image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810349541872/21BFFB5DCE5F332F7031485B284DC793B933C734/',\n        back = back_images.strategems.defensive,\n        keywords = {'Infantry'}\n    },\n    [\"Smokescreen\"] = {\n        category = 'DEFENSIVE',\n        name = ('[%s]SMOKESCREEN - 1CP[-]'):format(STRATEGEM_COLORS.defensive),\n        cost = 1,\n        desc = ([=[[b]Core – Battle Tactic Stratagem[/b]\n[i]Seeking salvation from incoming fire, warriors hurl themselves into whatever cover they can find.[/i]\n[%s][b]WHEN:[/b][-] Your opponent’s Shooting phase, just after an enemy unit has selected its targets.\n\n[%s][b]TARGET:[/b][-] One SMOKE unit from your army that was selected as the target of one or more of the attacking unit’s attacks.\n\n[%s][b]EFFECT:[/b][-] Until the end of the phase, all models in your unit have the Benefit of Cover and the Stealth ability.]=]\n        ):format(STRATEGEM_COLORS.defensive, STRATEGEM_COLORS.defensive, STRATEGEM_COLORS.defensive),\n        image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810350218153/D3CE7E94B96F114BE3BD71D7BE77F881CCF5788E/',\n        back = back_images.strategems.defensive,\n        keywords = {'Smoke'}\n    },\n    [\"Heroic Intervention\"] = {\n        category = 'DEFENSIVE',\n        name = ('[%s]HEROIC INTERVENTION - 2CP[-]'):format(STRATEGEM_COLORS.defensive),\n        cost = 2,\n        desc = ([=[[b]Core – Strategic Ploy Stratagem[/b]\n[i]Voices raised in furious war cries, your warriors surge forth to meet the enemy’s onslaught head-on.[/i]\n[%s][b]WHEN:[/b][-] Your opponent’s Charge phase, just after an enemy unit ends a Charge move.\n\n[%s][b]TARGET:[/b][-] One unit from your army that is within 6\" of that enemy unit and would be eligible to declare a charge against that enemy unit if it were your Charge phase.\n\n[%s][b]EFFECT:[/b][-] Your unit now declares a charge that targets only that enemy unit, and you resolve that charge as if it were your Charge phase.\n\n[%s][b]RESTRICTIONS:[/b][-] You can only select a VEHICLE unit from your army if it is a WALKER. Note that even if this charge is successful, your unit does not receive any Charge bonus this turn.]=]\n        ):format(STRATEGEM_COLORS.defensive, STRATEGEM_COLORS.defensive, STRATEGEM_COLORS.defensive, STRATEGEM_COLORS.defensive),\n        image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810350218067/57A04D95D23140B997D6321F61F9A802CBC0FC6D/',\n        back = back_images.strategems.defensive,\n        restriction = 'Vehicle',\n        exception = 'Walker'\n    },\n\n    --[ ADEPTA SORORITAS ]--\n    [\"Divine Intervention\"] = {\n        category = 'GENERAL',\n        name = ('[%s]DIVINE INTERVENTION - 1CP[-]'):format(STRATEGEM_COLORS.general),\n        cost = 1,\n        desc = ([=[[b]Hallowed Martyrs – Epic Deed Stratagem[/b]\n[i]Sometimes, a brush with death is so close the only explanation is divine intervention.[/i]\n[%s][b]WHEN:[/b][-] Any phase.\n\n[%s][b]TARGET:[/b][-] One ADEPTA SORORITAS CHARACTER unit from your army that was just destroyed. You can use this Stratagem on that unit even though it was just destroyed.\n\n[%s][b]EFFECT:[/b][-] Discard 1-3 Miracle dice. At the end of the phase, set the last destroyed model from your unit back up on the battlefield, as close as possible to where it was destroyed and not within Engagement Range of any enemy models. That model is set back up with a number of wounds remaining equal to the number of Miracle dice you discarded.\n\n[%s][b]RESTRICTIONS:[/b][-] You cannot select SAINT CELESTINE as the target of this Stratagem. You cannot select the same CHARACTER as the target of this Stratagem more than once per battle.]=]\n        ):format(STRATEGEM_COLORS.general, STRATEGEM_COLORS.general, STRATEGEM_COLORS.general, STRATEGEM_COLORS.general),\n        image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810353893408/799629C084E59D668002F0EFEBDC788BF06CE3DA/',\n        back = back_images.strategems.general,\n        faction = 'Adepta Sororitas',\n        keywords = {'Character'},\n        restriction = 'Saint Celestine',\n    },\n    [\"Holy Rage\"] = {\n        category = 'GENERAL',\n        name = ('[%s]HOLY RAGE - 1CP[-]'):format(STRATEGEM_COLORS.general),\n        cost = 1,\n        desc = ([=[[b]Hallowed Martyrs – Strategic Ploy Stratagem[/b]\n[i]With psalms on their lips, the faithful hurl themselves forward, striking the foe down with the inner strength born of faith in the Emperor.[/i]\n[%s][b]WHEN:[/b][-] Fight phase.\n\n[%s][b]TARGET:[/b][-] One ADEPTA SORORITAS unit from your army that has not been selected to fight this phase.\n\n[%s][b]EFFECT:[/b][-] Until the end of the phase, each time a model in your unit makes a melee attack, add 1 to the Wound roll.]=]\n        ):format(STRATEGEM_COLORS.general, STRATEGEM_COLORS.general, STRATEGEM_COLORS.general),\n        image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810353894120/CC67B5EACD682BC1F6885FEB51BD6DF99CD4FE4C/',\n        back = back_images.strategems.general,\n        faction = 'Adepta Sororitas'\n    },\n    [\"Suffering and Sacrifice\"] = {\n        category = 'GENERAL',\n        name = ('[%s]SUFFERING & SACRIFICE - 1CP[-]'):format(STRATEGEM_COLORS.general),\n        cost = 1,\n        desc = ([=[[b]Hallowed Martyrs – Strategic Ploy Stratagem[/b]\n[i]Suffering is a staple prayer for the Adepta Sororitas, and a martyr’s fate only brings greater glory to the God-Emperor.[/i]\n[%s][b]WHEN:[/b][-] Start of the Fight phase.\n\n[%s][b]TARGET:[/b][-] One ADEPTA SORORITAS INFANTRY or ADEPTA SORORITAS WALKER unit from your army.\n\n[%s][b]EFFECT:[/b][-] Until the end of the phase, each time an enemy model within Engagement range of your unit selects targets, it must select your unit as the target of its attacks.]=]\n        ):format(STRATEGEM_COLORS.general, STRATEGEM_COLORS.general, STRATEGEM_COLORS.general),\n        image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810353893645/6E35230A8C1617C6BA05C92C590DB820F239C1A4/',\n        back = back_images.strategems.general,\n        faction = 'Adepta Sororitas',\n        keywords = {'Infantry', 'Walker'}\n    },\n    [\"Light of the Emperor\"] = {\n        category = 'GENERAL',\n        name = ('[%s]LIGHT OF THE EMPEROR - 1CP[-]'):format(STRATEGEM_COLORS.general),\n        cost = 1,\n        desc = ([=[[b]Hallowed Martyrs – Battle Tactic Stratagem[/b]\n[i]The Emperor’s radiance shines upon his warriors, emboldening them amidst the thick of battle in their darkest hour.[/i]\n[%s][b]WHEN:[/b][-] Command phase.\n\n[%s][b]TARGET:[/b][-] One ADEPTA SORORITAS unit from your army that is below its Starting Strength. For the purposes of this Stratagem, if a unit has a Starting Strength of 1, it is considered to be below its Starting Strength while it has lost one or more wounds.\n\n[%s][b]EFFECT:[/b][-] Until the end of the turn, your unit can ignore any or all modifiers to its characteristics and/or to any roll or test made for it (excluding modifiers to saving throws).]=]\n        ):format(STRATEGEM_COLORS.general, STRATEGEM_COLORS.general, STRATEGEM_COLORS.general),\n        image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810353894975/7F33940BCB72DB5D674B7D754C33D4861029F18D/',\n        back = back_images.strategems.general,\n        faction = 'Adepta Sororitas'\n    },\n    [\"Rejoice the Fallen\"] = {\n        category = 'DEFENSIVE',\n        name = ('[%s]REJOICE THE FALLEN - 1CP[-]'):format(STRATEGEM_COLORS.defensive),\n        cost = 1,\n        desc = ([=[[b]Hallowed Martyrs – Strategic Ploy Stratagem[/b]\n[i]The death of a Battle Sister only stirs the survivors to fight harder to exact swift vengeance.[/i]\n[%s][b]WHEN:[/b][-] Your opponent’s Shooting phase, just after an enemy unit has resolved its attacks.\n\n[%s][b]TARGET:[/b][-] One ADEPTA SORORITAS unit from your army that had one or more of its models destroyed as a result of the attacking unit’s attacks.\n\n[%s][b]EFFECT:[/b][-] Your unit can shoot as if it were your Shooting phase, but it must target only that enemy unit when doing so, and can only do so if that enemy unit is an eligible target.]=]\n        ):format(STRATEGEM_COLORS.defensive, STRATEGEM_COLORS.defensive, STRATEGEM_COLORS.defensive),\n        image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810353894547/235835B31657F48061B9612AB75463AFC0AEC404/',\n        back = back_images.strategems.defensive,\n        faction = 'Adepta Sororitas'\n    },\n    [\"Spirit of the Martyr\"] = {\n        category = 'GENERAL',\n        name = ('[%s]SPIRIT OF THE MARTYR - 2CP[-]'):format(STRATEGEM_COLORS.general),\n        cost = 2,\n        desc = ([=[[b]Hallowed Martyrs – Strategic Ploy Stratagem[/b]\n[i]Even with their dying act, the Sororitas mete out the Emperor’s judgement.[/i]\n[%s][b]WHEN:[/b][-] Fight phase, just after an enemy unit has selected its targets.\n\n[%s][b]TARGET:[/b][-] One ADEPTA SORORITAS unit from your army that was selected as the target of one or more of the attacking unit’s attacks.\n\n[%s][b]EFFECT:[/b][-] Until the end of the phase, each time a model in your unit is destroyed, if that model has not fought this phase, do not remove it from play. The destroyed model can fight after the attacking model’s unit has finished making attacks, and is then removed from play.]=]\n        ):format(STRATEGEM_COLORS.general, STRATEGEM_COLORS.general, STRATEGEM_COLORS.general),\n        image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810353893593/DE5DB5109C12FA52DBC3F0598A3B8FBDF03C35B2/',\n        back = back_images.strategems.general,\n        faction = 'Adepta Sororitas'\n    },\n\n    --[ ASTRA MILITARUM ]--\n    [\"Reinforcements!\"] = {\n        category = 'GENERAL',\n        name = ('[%s]REINFORCEMENTS! - 2CP[-]'):format(STRATEGEM_COLORS.general),\n        cost = 2,\n        desc = ([=[[b]Combined Regiment – Strategic Ploy Stratagem[/b]\n[i]The Astra Militarum can call upon a nearly inexhaustible supply of warriors.[/i]\n[%s][b]WHEN:[/b][-] Any phase.\n\n[%s][b]TARGET:[/b][-] One REGIMENT unit from your army that was just destroyed. You can use this Stratagem on that unit even though it was just destroyed.\n\n[%s][b]EFFECT:[/b][-] Add a new unit to your army identical to your destroyed unit, in Strategic Reserves, at its Starting Strength and with all of its wounds remaining.\n\n[%s][b]RESTRICTIONS:[/b][-] This Stratagem cannot be used to return destroyed CHARACTER units to Attached units.]=]\n        ):format(STRATEGEM_COLORS.general, STRATEGEM_COLORS.general, STRATEGEM_COLORS.general, STRATEGEM_COLORS.general),\n        image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810353898248/C6799CC95B936189A4C79274179EB4D87C08754E/',\n        back = back_images.strategems.general,\n        faction = 'Astra Militarum',\n        keywords = {'Regiment'},\n        restriction = 'Character',\n    },\n    [\"Fields of Fire\"] = {\n        category = 'OFFENSIVE',\n        name = ('[%s]FIELDS OF FIRE - 2CP[-]'):format(STRATEGEM_COLORS.offensive),\n        cost = 2,\n        desc = ([=[[b]Combined Regiment – Battle Tactic Stratagem[/b]\n[i]Astra Militarum combat doctrine utilises the concentration of focused firepower to hammer the foe from multiple angles.[/i]\n[%s][b]WHEN:[/b][-] Your Shooting phase.\n\n[%s][b]TARGET:[/b][-] One REGIMENT or SQUADRON unit from your army that has not been selected to shoot this phase.\n\n[%s][b]EFFECT:[/b][-] After your unit has resolved its attacks, select one enemy unit that was targeted by one or more of those attacks. Until the end of the phase, each time an attack is made against that enemy unit by a REGIMENT or SQUADRON model from your army, unless the attacking unit is Battle-shocked, improve the Armour Penetration characteristic of that attack by 1.]=]\n        ):format(STRATEGEM_COLORS.offensive, STRATEGEM_COLORS.offensive, STRATEGEM_COLORS.offensive),\n        image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810353901003/BBF7B729E4A533DAC456CFCAE7CC435A85022693/',\n        back = back_images.strategems.offensive,\n        faction = 'Astra Militarum',\n        keywords = {'Regiment', 'Squadron'}\n    },\n    [\"Suppression Fire\"] = {\n        category = 'OFFENSIVE',\n        name = ('[%s]SUPPRESSION FIRE - 1CP[-]'):format(STRATEGEM_COLORS.offensive),\n        cost = 1,\n        desc = ([=[[b]Combined Regiment – Strategic Ploy Stratagem[/b]\n[i]Ordered to focus a rapid and repeated volley of fire, soldiers are able to rattle even the staunchest foe with a blizzard of shots.[/i]\n[%s][b]WHEN:[/b][-] Your Shooting phase.\n\n[%s][b]TARGET:[/b][-] One ASTRA MILITARUM INFANTRY unit from your army that has not been selected to shoot this phase, and one enemy unit (excluding MONSTERS and VEHICLES)\n\n[%s][b]EFFECT:[/b][-] If your ASTRA MILITARUM unit scores one or more hits against that enemy unit this phase, until the end of your opponent’s next turn, each time a model in that enemy unit makes an attack, subtract 1 from the Hit roll.]=]\n        ):format(STRATEGEM_COLORS.offensive, STRATEGEM_COLORS.offensive, STRATEGEM_COLORS.offensive),\n        image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810353896325/F06E670970EDB967BBC027BE283BC93633D61356/',\n        back = back_images.strategems.offensive,\n        faction = 'Astra Militarum',\n        keywords = {'Infantry'}\n    },\n    [\"Expert Bombardiers\"] = {\n        category = 'OFFENSIVE',\n        name = ('[%s]EXPERT BOMBARDIERS - 1CP[-]'):format(STRATEGEM_COLORS.offensive),\n        cost = 1,\n        desc = ([=[[b]Combined Regiment – Strategic Ploy Stratagem[/b]\n[i]Skilled in coordinating their targeting with forward spotter elements, this regiment’s artillery crews are capable of devastating precision shelling.[/i]\n[%s][b]WHEN:[/b][-] Start of your Shooting phase.\n\n[%s][b]TARGET:[/b][-] One ASTRA MILITARUM unit from your army equipped with a vox-caster, and one enemy unit that is visible to that unit.\n\n[%s][b]EFFECT:[/b][-] Until the end of the phase, each time an ASTRA MILITARUM model from your army makes an attack with an Indirect Fire weapon that targets that enemy unit, unless the attacking model is Battle-shocked, add 1 to the Hit roll.]=]\n        ):format(STRATEGEM_COLORS.offensive, STRATEGEM_COLORS.offensive, STRATEGEM_COLORS.offensive),\n        image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810353897466/42F39D360A22FA33C6AF11C3306F19F63A1C2C77/',\n        back = back_images.strategems.offensive,\n        faction = 'Astra Militarum',\n        ability = 'Vox-caster'\n    },\n    [\"Inspired Command\"] = {\n        category = 'DEFENSIVE',\n        name = ('[%s]INSPIRED COMMAND - 1CP[-]'):format(STRATEGEM_COLORS.defensive),\n        cost = 1,\n        desc = ([=[[b]Combined Regiment – Epic Deed Stratagem[/b]\n[i]This officer is known for their strategic excellence, as are those they command. Honed over many years, their curt, well-established battle cant is wielded with consummate efficiency, reinforced by the inspirational example they themselves set.[/i]\n[%s][b]WHEN:[/b][-] Your opponent’s Command phase.\n\n[%s][b]TARGET:[/b][-] One ASTRA MILITARUM OFFICER unit from your army.\n\n[%s][b]EFFECT:[/b][-] Your OFFICER can issue one Order as if it were your Command phase.\n\n[%s][b]RESTRICTIONS: Your OFFICER cannot issue that Order to a Battle-shocked unit.[/b][-]]=]\n        ):format(STRATEGEM_COLORS.defensive, STRATEGEM_COLORS.defensive, STRATEGEM_COLORS.defensive, STRATEGEM_COLORS.defensive),\n        image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810353901357/5CCA31882D18238DD9C61305AF444B3B5E88111D/',\n        back = back_images.strategems.defensive,\n        faction = 'Astra Militarum',\n        keywords = {'Officer'}\n    },\n    [\"Armoured Might\"] = {\n        category = 'DEFENSIVE',\n        name = ('[%s]ARMOURED MIGHT - 2CP[-]'):format(STRATEGEM_COLORS.defensive),\n        cost = 2,\n        desc = ([=[[b]Combined Regiment – Wargear Stratagem[/b]\n[i]The tanks of the Imperial Guard are armoured not only in reinforced plas-steel, but with devout faith in the Emperor and utter contempt for their foes.[/i]\n[%s][b]WHEN:[/b][-] Your opponent’s Shooting phase, just after an enemy unit has selected its targets.\n\n[%s][b]TARGET:[/b][-] One ASTRA MILITARUM VEHICLE unit from your army that was selected as the target of one or more of the attacking unit’s attacks.\n\n[%s][b]EFFECT:[/b][-] Until the end of the phase, each time an attack is allocated to your unit, subtract 1 from the Damage characteristic of that attack.]=]\n        ):format(STRATEGEM_COLORS.defensive, STRATEGEM_COLORS.defensive, STRATEGEM_COLORS.defensive),\n        image = 'https://steamusercontent-a.akamaihd.net/ugc/2467488810353900392/1D9E84237A4FA2063B9DB749EAC3B76C0E596D4E/',\n        back = back_images.strategems.defensive,\n        faction = 'Astra Militarum',\n        keywords = {'Vehicle'}\n    },\n}\n\n-- [ Patches for incorrect names ]\nweapons.ranged[\"Spike Rifle\"] = weapons.ranged[\"Spike rifle\"]\nweapons.ranged[\"Toxic harpoons\"] = weapons.ranged[\"Toxinjector harpoon\"]\nweapons.melee[\"Bio-weapons\"] = weapons.melee[\"Claws and talons\"]\nweapons.melee[\"Monstrous sharp claws\"] = weapons.melee[\"Talons\"]\nweapons.melee[\"Toxic harpoons\"] = weapons.melee[\"Toxinjector harpoon\"]\n\nlocal last_player_color  ---@type PlayerColor\n\n---Waiting for unit to generate weapon tokens.\nlocal making_weapon_tokens = false\nlocal making_strategem_tokens = false\n\nlocal bag  ---@type Container\n\n---@class TokenBuilder\n---@field count int Number of copies to make.\n---@field token_name string Token name.\n---@field weapon_type WeaponType\n---@field color 'c6c930'|'5785fe'\n---@field weapon_name string\n---@field stats string\n---@field unit_tag string\nlocal TokenBuilder = {\n    count = 1,\n    color = 'c6c930'\n}\n\n\n---Create new TokenBuilder object.\n---@param count int\n---@param token_name string\n---@param weapon_type 'ranged'|'melee'\n---@param color string\n---@param weapon_name string\n---@param stats string\n---@param unit_tag string\n---@return TokenBuilder\nfunction TokenBuilder:new(count, token_name, weapon_type, color, weapon_name, stats, unit_tag)\n    obj = {\n        count = count,\n        token_name = token_name,\n        weapon_type = weapon_type,\n        color = color,\n        weapon_name = weapon_name,\n        stats = stats,\n        unit_tag = unit_tag\n    }  ---@type TokenBuilder\n    setmetatable(obj, self)\n    self.__index = self\n    return obj\nend\n\n---Create tokens for this weapon.\nfunction TokenBuilder:makeTokens()\n    for _ = 1, self.count do\n        spawnObject{\n            type = 'Custom_Tile',\n            scale = {0.5, 1, 0.5},\n            callback_function=|obj| self:setToken(obj)\n        }\n    end\nend\n\n---Set token properties.\n---@param token Object\nfunction TokenBuilder:setToken(token)\n    local image, back  ---@type string, string\n    local token_name = self.token_name:gsub('%s*%([Rr]anged%)', ''):gsub('%s*%([Mm]elee%)', '')\n    local weapon_name = self.weapon_name\n    local weapon_list = weapons[self.weapon_type]\n    local weapon = weapon_list[weapon_name]\n    while not weapon and weapon_name do\n        weapon_name = weapon_name:sub(1, 1):upper() .. weapon_name:sub(2)\n        weapon = weapon_list[weapon_name]\n        if weapon then\n            break\n        end\n        weapon = weapon_list[weapon_name:gsub('s$', '')]\n        if weapon then\n            weapon_name = weapon_name:gsub('s$', '')\n            break\n        end\n        local twinname = nil  ---@type string\n        local twin, twinweapon = weapon_name:match('^(Twin) %S+ (.+)')  ---@type string, string\n        if twin then\n            twinname = 'Twin-linked '..twinweapon\n            weapon = weapon_list[twinname]\n            if weapon then\n                weapon_name = twinname\n                break\n            end\n        else\n            twin, twinweapon = weapon_name:match('^(Twin-linked) %S+ (.+)')  ---@type string, string\n            if twin then\n                twinname = 'Twin '..twinweapon\n                weapon = weapon_list[twinname]\n                if weapon then\n                    weapon_name = twinname\n                    break\n                end\n            end\n        end\n        if twinname then\n            twinname = twinname:gsub('s$', '')\n            weapon = weapon_list[twinname]\n            if weapon then\n                weapon_name = twinname\n                break\n            end\n            twinname = twinweapon:sub(1, 1):upper() .. twinweapon:sub(2)\n            weapon = weapon_list[twinname]\n            if weapon then\n                weapon_name = twinname\n                break\n            end\n            twinname = twinname:gsub('s$', '')\n            weapon = weapon_list[twinname]\n            if weapon then\n                weapon_name = twinname\n                break\n            end\n            weapon_name = twin..twinweapon:match('%S+%s+(.*)')  ---@type string\n        else\n            weapon_name = weapon_name:match('%S+%s+(.*)')  ---@type string\n        end\n    end\n    ---@cast weapon WeaponData\n    if weapon then\n        image = weapon.image\n        back = back_images[weapon.legendary or false][weapon.psychic or false]\n    else\n        local is_psychic = (self.color:lower() == '5785fe')\n        image = default_images[self.weapon_type][is_psychic]\n        back = back_images[false][is_psychic]\n    end\n    token.setCustomObject{\n        image = image,\n        type = 2,\n        image_bottom = back,\n        thickness = 0.1,\n        stackable = true\n    }\n    if weapons[self.weapon_type == 'ranged' and 'melee' or 'ranged'][weapon_name] then\n        token_name = token_name:gsub('%[%-%]', (' (%s%s)[-]'):format(self.weapon_type:sub(1,1):upper(), self.weapon_type:sub(2)))\n    end\n    token.setName(token_name)\n    local desc = self.stats:gsub('BS:N/A', 'BS:-')\n    if token_name:match(' | Half Range') then\n        local n ---@type integer\n        local stat_color = '00ff33'\n        local range = desc:match('^(%d+).%f[%s]')  ---@type string?\n        if range then\n            local new_range = math.floor(tonumber(range)/2)\n            desc = desc:gsub('^%d+(.)%f[%s]', ('[%s]%d%%1[-]'):format(stat_color, new_range))\n        end\n        local rapid_fire = desc:match('Rapid Fire (%d+)') or desc:match('RF(%d+)')  ---@type string?\n        if rapid_fire then\n            local atkstr = desc:match('A:([D%d+]+)')  ---@type string\n            local attacks = atkstr:match('^%d+$') or atkstr:match('^%d*D%d+%+(%d+)$') or 0\n            local new_attacks = tonumber(attacks) + tonumber(rapid_fire)  ---@type integer\n            desc, n = desc:gsub('(A:%d*D%d+%+)%d+', '[%%s]%1%%d[-]')\n            if n == 0 then\n                desc, n = desc:gsub('A:%d*D%d+', '[%%s]%1+%%d[-]')\n            end\n            if n == 0 then\n                desc = desc:gsub('(A:)%d+', '[%%s]%1%%d[-]')\n            end\n            desc = desc:format(stat_color, new_attacks)\n        end\n        local melta = desc:match('Melta (%d+)') or desc:match('ML(%d+)')  ---@type string?\n        if melta then\n            local dmgstr = desc:match('D:([D%d+]+)')  ---@type string\n            local damage = dmgstr:match('^%d+$') or dmgstr:match('^%d*D%d+%+(%d+)$') or 0\n            local new_damage = tonumber(damage) + tonumber(melta)  ---@type integer\n            desc, n = desc:gsub('(D:%d*D%d+%+)%d+', '[%%s]%1%%d[-]')  ---@type string\n            if n == 0 then\n                desc, n = desc:gsub('D:%d*D%d+', '[%%s]%1+%%d[-]')\n            end\n            if n == 0 then\n                desc = desc:gsub('(D:)%d+', '[%%s]%1%%d[-]')\n            end\n            desc = desc:format(stat_color, new_damage)\n        end\n    end\n    if not desc:match('\\u{2514}') then\n        desc = desc:gsub('\\n%s+', '\\n'):trim()\n    end\n    token.setDescription(desc)\n    token.addTag(self.unit_tag)\n    token.locked = false\n    token.auto_raise = true\n    bag.putObject(token)\nend\n\n\n---onLoad handler. Adds context menus.\nfunction onLoad()\n    self.addContextMenuItem(\n        'Make Weapon Tokens',\n        function (player_color, object_position, object)\n            making_weapon_tokens = true\n            last_player_color = player_color\n        end\n    )\n    self.addContextMenuItem(\n        'Make Strat. Tokens',\n        function (player_color, object_position, object)\n            making_strategem_tokens = true\n            last_player_color = player_color\n        end\n    )\n    self.addContextMenuItem(\n        'Make All Tokens',\n        function (player_color, object_position, object)\n            making_weapon_tokens = true\n            making_strategem_tokens = true\n            last_player_color = player_color\n        end\n    )\nend\n\n---onObjectPickup handler. Will trigger doing the things.\n---@param player_color color\n---@param picked_up_object object\nfunction onObjectPickUp(player_color, picked_up_object)\n    if not self.hasTag(\"lsUpgrader\") then return end\n    GenerateTokens(picked_up_object)\nend\n\n\n---onPlayerAction handler. Selecting objects will trigger doing the things.\n---@param player Player\n---@param action Action\n---@param targets object[]\nfunction onPlayerAction(player, action, targets)\n    if not self.hasTag(\"lsUpgrader\") then return end\n    if action == Player.Action.Select then\n        GenerateTokens(table.unpack(targets))\n    end\nend\n\n---@alias WeaponProfile { count: int, color: string, token_name: string, weapon_name: string, profile_name: string, stats: string }\n\n---Generates weapon tokens for all models in the given unit.\n---@param unit_tag string Tag identifing unit.\nfunction GenerateWeaponTokens(unit_tag)\n    local unit_models = getObjectsWithAllTags{unit_tag, 'lsModel'}\n    local desc, rangedHEnd, meleeHStart, meleeHEnd, abl\n    ---@param weapon_section string\n    ---@param weapon_type WeaponType\n    local function parseWeapons(weapon_section, weapon_type)\n        if not weapon_section then return end\n        local profiles = {}  ---@type WeaponProfile[]\n\n        local color\n        function makeProfiles()\n            local prof_stats = {}  ---@type string[]\n            local profile_weapon = {}  ---@type WeaponProfile[]\n            for i, prof in ipairs(profiles) do\n                table.insert(prof_stats, ('[%s]\\u{2514} %s[-]\\n    %s'):format(prof.color, prof.profile_name, prof.stats:ltrim():gsub('\\n%[', '\\n    [')))\n                prof.token_name = ('[%s]%s[-]'):format(profiles[i].color, prof.token_name)\n                table.insert(profile_weapon, prof)\n            end\n            local weap_stats = table.concat(prof_stats, '\\n')\n            local base_name = ('[%s]%s[-]'):format(profiles[1].color, profiles[1].weapon_name)\n            TokenBuilder:new(profiles[1].count, base_name, weapon_type, profiles[1].color, profiles[1].weapon_name, weap_stats, unit_tag):makeTokens()\n            for _, prof in ipairs(profile_weapon) do\n                TokenBuilder:new(prof.count, prof.token_name, weapon_type, prof.color, prof.weapon_name, prof.stats, unit_tag):makeTokens()\n                if checkHalfRangeAttrs(prof.stats) then\n                    TokenBuilder:new(prof.count, prof.token_name..' | Half Range', weapon_type, prof.color, prof.weapon_name, prof.stats, unit_tag):makeTokens()\n                end\n            end\n            profiles = {}\n        end\n        local weapon_name, token_name, stats, prev_weapon, profile_name, prev_profile, prev_color, count  ---@type string, string, string, string, string?, string?, string, integer\n        for line in weapon_section:gmatch('[^\\n\\r]+') do\n            color, weapon_name = line:match('^%[(%x+)%](%w[^[]*)') ---@type string, string\n            profile_name = line:match('^[%s\\u{2514}]+%[%x+%](%w.-)%[%-%]$') or line:match('^[%s\\u{2514}]+(%w.-)%[%-%]$') or line:match('^%[%x+%][%s\\u{2514}]+(%w.-)%[%-%]$')  ---@type string?\n            log(profile_name)\n            if color and weapon_name then\n                -- check for arrows\n                local prof_weapon\n                prof_weapon, profile_name = line:match('%]\\u{25ba}%s(.-)%s%-%s(.-)%[')  ---@type string?, string?\n                if prof_weapon and profile_name and not profile_name:lower():match('ranged') and not profile_name:lower():match('melee') then\n                    weapon_name = prof_weapon\n                    line = line:gsub('\\u{25ba}%s', '')\n                end\n                if prev_profile then\n                    table.insert(profiles, {count=count, color=prev_color, token_name=token_name, weapon_name=prev_weapon, profile_name=prev_profile, stats=stats})\n                    if weapon_name ~= prev_weapon then\n                        makeProfiles()\n                    end\n                elseif prev_weapon then\n                    if not token_name:find('%[%-%]') then\n                        token_name = token_name..'[-]'\n                    end\n                    TokenBuilder:new(count, token_name, weapon_type, prev_color, prev_weapon, stats, unit_tag):makeTokens()\n                    if checkHalfRangeAttrs(stats) then\n                        TokenBuilder:new(count, token_name..' | Half Range', weapon_type, prev_color, prev_weapon, stats, unit_tag):makeTokens()\n                    end\n                end\n                local count_str, wnmult = line:match('(%d+)\\u{00d7}(%w[^[]*)')  ---@type string, string\n                if count_str then\n                    count = tonumber(count_str)  --[[@as integer]]\n                    weapon_name = wnmult:trim()\n                    token_name = ('[%s]%s[-]'):format(color, weapon_name)\n                else\n                    count = 1\n                    token_name = line\n                end\n                prev_weapon = weapon_name\n                prev_profile = profile_name\n                prev_color = color\n            elseif line:match('A:[%dD]+') then\n                stats = line:rtrim()\n            elseif line:match('%[su[bp]%]%[%x+%]%[[^%[%]]+%]%[%-%]%[/su[bp]%]') then\n                stats = stats..'\\n'..line:rtrim()\n            elseif profile_name then\n                if prev_profile then\n                    table.insert(profiles, {count=count, color=prev_color, token_name=token_name, weapon_name=prev_weapon, profile_name=prev_profile, stats=stats})\n                end\n                if prev_color ~= '5785fe' then\n                    token_name = prev_weapon..' - '..profile_name:lower()\n                else\n                    token_name = prev_weapon..' - '..profile_name\n                end\n                prev_profile = profile_name\n            end\n        end\n        if prev_profile then\n            table.insert(profiles, {count=count, color=prev_color, token_name=token_name, weapon_name=prev_weapon, profile_name=prev_profile, stats=stats})\n            makeProfiles()\n        elseif prev_weapon then\n            if not token_name:find('%[%-%]') then\n                token_name = token_name..'[-]'\n            end\n            TokenBuilder:new(count, token_name, weapon_type, prev_color, prev_weapon, stats, unit_tag):makeTokens()\n            if checkHalfRangeAttrs(stats) then\n                TokenBuilder:new(count, token_name..' | Half Range', weapon_type, prev_color, prev_weapon, stats, unit_tag):makeTokens()\n            end\n        end\n    end\n    for _, model in ipairs(unit_models) do\n        desc = model.getDescription()\n        _, rangedHEnd = desc:find('%[e85545%]Ranged weapons%[%-%]')\n        rangedHEnd = rangedHEnd or 1\n        abl = desc:find('%[dc61ed%]%w*%s?Abilities%[%-%]') or #desc\n        meleeHStart, meleeHEnd = desc:find('%[e85545%]Melee weapons%[%-%]')\n        meleeHStart, meleeHEnd = meleeHStart or abl, meleeHEnd or abl\n        parseWeapons(desc:sub(rangedHEnd + 1, meleeHStart - 1), 'ranged')\n        parseWeapons(desc:sub(meleeHEnd + 1, abl - 1), 'melee')\n    end\nend\n\n---@param unit_tag string\nfunction GenerateStrategemTokens(unit_tag)\n    local leader_models = getObjectsWithAllTags{unit_tag, 'leaderModel'}\n    local unit_data = leader_models[1].getTable('unitData')  ---@type UnitData\n    for _, strategem in pairs(strategems) do\n        if not strategem.faction or unit_data.factionKeywords:match(strategem.faction) then\n            local matched_keywords = false\n            if strategem.keywords then\n                for _, keyword in ipairs(strategem.keywords) do\n                    if unit_data.keywords:match('%f[%w]'..keyword..'%f[%W]') then\n                        matched_keywords = true\n                        break\n                    end\n                end\n            else\n                matched_keywords = true\n            end\n            if (\n                    matched_keywords\n                    and (\n                        not strategem.restriction\n                        or not unit_data.keywords:match('%f[%w]'..strategem.restriction..'%f[%W]')\n                        or (strategem.exception and unit_data.keywords:match('%f[%w]'..strategem.exception..'%f[%W]'))\n                    )\n                    and (not strategem.ability or unit_data.abilities[strategem.ability])\n                ) then\n                spawnObject{\n                    type = 'Custom_Tile',\n                    rotation = {0, 45, 0},\n                    scale = {0.5, 1, 0.5},\n                    callback_function=|obj| setStrategemToken(obj, strategem, unit_tag)\n                }\n            end\n        end\n    end\nend\n\n---@param ... object\nfunction GenerateTokens(...)\n    models = {...}\n    if making_weapon_tokens or making_strategem_tokens then\n        local uuids = {}  ---@type { [string]: boolean }\n        for _, model in ipairs(models) do\n            for _, tag in ipairs(model.getTags()) do\n                local uuid_tag = tag:match('uuid_'..('%x'):rep(8)..'$')  ---@type string\n                if uuid_tag then\n                    if not uuids[uuid_tag] then\n                        uuids[uuid_tag] = true\n                        bag = findBag(uuid_tag)\n                        if bag then\n                            if making_weapon_tokens then\n                                GenerateWeaponTokens(uuid_tag)\n                            end\n                            if making_strategem_tokens then\n                                GenerateStrategemTokens(uuid_tag)\n                            end\n                            broadcastToColor('Tokens generated.', last_player_color, last_player_color)\n                        end\n                    end\n                    break\n                end\n            end\n        end\n    end\n    making_weapon_tokens = false\n    making_strategem_tokens = false\nend\n\n\n---@param token object\n---@param strategem StrategemData\n---@param unit_tag string\nfunction setStrategemToken(token, strategem, unit_tag)\n    token.setName(strategem.name)\n    token.setDescription(strategem.desc)\n    token.setCustomObject{\n        image = strategem.image,\n        type = 0,\n        image_bottom = strategem.back,\n        thickness = 0.1\n    }\n    token.addTag(unit_tag)\n    token.locked = false\n    token.auto_raise = true\n    bag.putObject(token)\nend\n\n---@param uuid_tag string\n---@return Container\n---@nodiscard\nfunction findBag(uuid_tag)\n    local token_bag\n    local bounds = self.getBounds()\n    local top = bounds.center.y + bounds.size.y/2\n    local bags = getObjectsWithAllTags{uuid_tag, uuid_tag .. '_tokenBag'}  ---@type Container[]\n    if #bags == 0 then\n        token_bag = spawnObject(\n            {\n                type='Bag',\n                position={x=bounds.center.x, y=top, z=bounds.center.z}\n            }\n        )  --[[@as Container]]\n        token_bag.addTag(uuid_tag)\n        token_bag.addTag(uuid_tag .. '_tokenBag')\n        local leader_models = getObjectsWithAllTags{uuid_tag, 'leaderModel'}\n        local model = leader_models[1]\n        local unit_data = model.getTable('unitData')  ---@type UnitData\n        local unit_name = unit_data.unitDecorativeName or unit_data.unitName\n        token_bag.setName(unit_name..' Tokens')\n    elseif #bags > 1 then\n        broadcastToColor('Error: multiple bags found', last_player_color, last_player_color)\n    else\n        token_bag = bags[1]\n        token_bag.setPosition{x=bounds.center.x, y=top, z=bounds.center.z}\n    end\n    return token_bag\nend\n---@param stats string\nfunction checkHalfRangeAttrs(stats)\n    return (\n        (stats:match('Rapid Fire %d') or stats:match('RF%d') or stats:match('Melta %d') or stats:match('ML%d')) and true\n        or false\n    )\nend\n\n---@param s string\nfunction string.trim(s)\n    return s:ltrim():rtrim()\nend\n\n---@param s string\nfunction string.ltrim(s)\n    return s:gsub('^%s+', '')\nend\n\n---@param s string\nfunction string.rtrim(s)\n    return s:gsub('%s+$', '')\nend",
            "LuaScriptState": "",
            "XmlUI": ""
        }
    ]
}